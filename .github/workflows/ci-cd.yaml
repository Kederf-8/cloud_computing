name: CI/CD Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            # Checkout the repository
            - name: Checkout code
              uses: actions/checkout@v2

            # Set up Google Cloud SDK
            - name: Set up Google Cloud SDK
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}
                  service_account_key: ${{ secrets.GCP_SA_KEY }}
                  export_default_credentials: true
                  install_components: "beta"

            # Authenticate Docker to Google Container Registry (GCR)
            - name: Authenticate Docker to gcr.io
              run: |
                  echo "${{ secrets.GCP_SA_KEY }}" | docker login -u _json_key --password-stdin https://gcr.io

            # Build and push Docker images for backend, frontend, and sender
            - name: Build and push Backend image
              run: |
                  docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend ./Backend
                  docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend

            - name: Build and push Frontend image
              run: |
                  docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend ./Frontend
                  docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend

            - name: Build and push Data-Sender image
              run: |
                  docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/data-sender ./Data-Sender
                  docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/data-sender

            # Get GKE credentials to interact with Kubernetes cluster
            - name: Get GKE credentials
              run: |
                  gcloud container clusters get-credentials sensor-cluster --region us-central1-a

            # Deploy to Kubernetes
            - name: Deploy Backend to Kubernetes
              run: |
                  kubectl apply -f backend-deployment.yaml

            - name: Deploy Frontend to Kubernetes
              run: |
                  kubectl apply -f frontend-deployment.yaml

            - name: Deploy Data-Sender to Kubernetes
              run: |
                  kubectl apply -f sender-deployment.yaml
